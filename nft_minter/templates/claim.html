{% extends "base.html" %}

{% block title %}é¢†å– NFT - ç”Ÿæ—¥ NFT é“¸é€ ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="claim-container">
    <div class="claim-card">
        <div class="claim-header">
            <h1><i class="fas fa-gift"></i> é¢†å–ç”Ÿæ—¥ NFT</h1>
            <p>æ¯å¹´å…è´¹é“¸é€ ä¸€æšä¸“å±ç”Ÿæ—¥çºªå¿µ NFT</p>
        </div>

        <div class="claim-body">
            <!-- æœªè¿æ¥é’±åŒ… -->
            <div id="notConnected" class="claim-state">
                <div class="connect-prompt">
                    <i class="fas fa-wallet"></i>
                    <h3>è¯·å…ˆè¿æ¥é’±åŒ…</h3>
                    <p>è¿æ¥æ‚¨çš„ MetaMask é’±åŒ…ä»¥ç»§ç»­</p>
                    <button onclick="connectWallet()" class="btn btn-lg btn-primary">
                        <i class="fas fa-plug"></i> è¿æ¥é’±åŒ…
                    </button>
                </div>
            </div>

            <!-- å·²è¿æ¥ï¼Œæ˜¾ç¤ºé¢†å–çŠ¶æ€ -->
            <div id="connectedState" class="claim-state" style="display: none;">
                <!-- å·²é“¸é€  -->
                <div id="alreadyMinted" style="display: none;">
                    <div class="minted-info">
                        <i class="fas fa-check-circle"></i>
                        <h3>æ‚¨ä»Šå¹´å·²ç»é¢†å–è¿‡å•¦ï¼</h3>
                        <p>æ¯ä¸ªåœ°å€æ¯å¹´åªèƒ½é¢†å–ä¸€æ¬¡ç”Ÿæ—¥ NFT</p>
                        <p>æ˜å¹´åŒä¸€æ—¶é—´å†æ¥å§~</p>
                        <a href="{{ url_for('my_nfts') }}" class="btn btn-secondary">
                            <i class="fas fa-images"></i> æŸ¥çœ‹æˆ‘çš„ NFT
                        </a>
                    </div>
                </div>

                <!-- æœªé“¸é€  -->
                <div id="notMinted" style="display: none;">
                    <div class="mint-info">
                        <div class="nft-preview-large">
                            <div class="nft-image-large">
                                <i class="fas fa-gem"></i>
                            </div>
                            <h3>Birthday Memorial 2024</h3>
                            <p>æ‚¨çš„ä¸“å±ç”Ÿæ—¥çºªå¿µ NFT</p>
                        </div>

                        <div class="mint-details">
                            <div class="detail-row">
                                <span>ç½‘ç»œ</span>
                                <span>Polygon Amoy æµ‹è¯•ç½‘</span>
                            </div>
                            <div class="detail-row">
                                <span>Gas è´¹ç”¨</span>
                                <span>â‰ˆ å…è´¹</span>
                            </div>
                            <div class="detail-row">
                                <span>é™é‡</span>
                                <span>æ¯åœ°å€æ¯å¹´ 1 æš</span>
                            </div>
                        </div>

                        <button id="mintBtn" onclick="mintNFT()" class="btn btn-lg btn-primary">
                            <i class="fas fa-magic"></i> ç«‹å³é¢†å–
                        </button>

                        <p class="mint-note">
                            <i class="fas fa-info-circle"></i>
                            é¦–æ¬¡ä½¿ç”¨éœ€è¦æ·»åŠ  Polygon Amoy æµ‹è¯•ç½‘ç»œåˆ° MetaMask
                        </p>
                    </div>
                </div>

                <!-- é“¸é€ ä¸­ -->
                <div id="minting" style="display: none;">
                    <div class="minting-progress">
                        <div class="spinner"></div>
                        <h3>æ­£åœ¨é“¸é€ ä¸­...</h3>
                        <p>è¯·ç­‰å¾…äº¤æ˜“ç¡®è®¤</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Network Modal -->
<div id="networkModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>åˆ‡æ¢åˆ° Polygon ç½‘ç»œ</h3>
            <button onclick="closeModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <p>è¯·å…ˆåˆ‡æ¢åˆ° Polygon ç½‘ç»œæ‰èƒ½é¢†å– NFT</p>
            <button onclick="switchNetwork()" class="btn btn-primary">
                <i class="fas fa-exchange-alt"></i> åˆ‡æ¢ç½‘ç»œ
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const CHAIN_ID = {{ network_info.chain_id if network_info else 80001 }};
const CONTRACT_ADDRESS = '{{ contract_address }}';

// æ£€æŸ¥ç½‘ç»œ
async function checkNetwork() {
    if (!window.ethereum) return false;

    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
    return parseInt(chainId) === CHAIN_ID;
}

// åˆ‡æ¢ç½‘ç»œ
async function switchNetwork() {
    const chainIdHex = '0x' + CHAIN_ID.toString(16);

    try {
        await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: chainIdHex }]
        });
    } catch (switchError) {
        // ç½‘ç»œæœªæ·»åŠ ï¼Œå°è¯•æ·»åŠ 
        if (switchError.code === 4902) {
            try {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: chainIdHex,
                        chainName: 'Polygon Amoy Testnet',
                        rpcUrls: ['https://rpc-amoy.polygon.technology'],
                        nativeCurrency: {
                            name: 'MATIC',
                            symbol: 'MATIC',
                            decimals: 18
                        },
                        blockExplorerUrls: ['https://amoy.polygonscan.com']
                    }]
                });
            } catch (addError) {
                console.error('æ·»åŠ ç½‘ç»œå¤±è´¥:', addError);
            }
        }
    }
}

// æ£€æŸ¥æ˜¯å¦å·²é“¸é€ 
async function checkMintStatus(address) {
    try {
        const response = await fetch(`/api/check/${address}`);
        const data = await response.json();

        if (data.has_minted) {
            showAlreadyMinted();
        } else {
            showNotMinted();
        }
    } catch (error) {
        console.error('æ£€æŸ¥çŠ¶æ€å¤±è´¥:', error);
    }
}

// æ˜¾ç¤ºä¸åŒçŠ¶æ€
function showConnected() {
    document.getElementById('notConnected').style.display = 'none';
    document.getElementById('connectedState').style.display = 'block';
}

function showAlreadyMinted() {
    document.getElementById('alreadyMinted').style.display = 'block';
    document.getElementById('notMinted').style.display = 'none';
}

function showNotMinted() {
    document.getElementById('alreadyMinted').style.display = 'none';
    document.getElementById('notMinted').style.display = 'block';
}

function showMinting() {
    document.getElementById('notMinted').style.display = 'none';
    document.getElementById('minting').style.display = 'block';
}

// é“¸é€  NFT
async function mintNFT() {
    if (!currentAccount) {
        await connectWallet();
        return;
    }

    // æ£€æŸ¥ç½‘ç»œ
    const isCorrectNetwork = await checkNetwork();
    if (!isCorrectNetwork) {
        document.getElementById('networkModal').style.display = 'flex';
        return;
    }

    showMinting();

    try {
        // å‡†å¤‡äº¤æ˜“
        const response = await fetch('/api/prepare-tx', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address: currentAccount })
        });

        const data = await response.json();

        if (data.error) {
            throw new Error(data.error);
        }

        // å‘é€äº¤æ˜“
        const txHash = await window.ethereum.request({
            method: 'eth_sendTransaction',
            params: [data.transaction]
        });

        showSuccess('äº¤æ˜“å·²å‘é€! ç­‰å¾…ç¡®è®¤...');

        // ç­‰å¾…äº¤æ˜“ç¡®è®¤
        const receipt = await waitForReceipt(txHash);

        if (receipt && receipt.status === '0x1') {
            showSuccess('ğŸ‰ NFT é“¸é€ æˆåŠŸ!');
            showAlreadyMinted();
        } else {
            throw new Error('äº¤æ˜“å¤±è´¥');
        }

    } catch (error) {
        console.error('é“¸é€ å¤±è´¥:', error);
        showError('é“¸é€ å¤±è´¥: ' + error.message);
        showNotMinted();
    }
}

// ç­‰å¾…äº¤æ˜“ç¡®è®¤
async function waitForReceipt(txHash) {
    while (true) {
        const receipt = await window.ethereum.request({
            method: 'eth_getTransactionReceipt',
            params: [txHash]
        });
        if (receipt) return receipt;
        await new Promise(r => setTimeout(r, 2000));
    }
}

function closeModal() {
    document.getElementById('networkModal').style.display = 'none';
}

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è¿æ¥çŠ¶æ€
window.addEventListener('load', async () => {
    if (currentAccount) {
        showConnected();
        if (await checkNetwork()) {
            await checkMintStatus(currentAccount);
        }
    }
});

// ç›‘å¬è´¦æˆ·å˜åŒ–
window.ethereum?.on('accountsChanged', (accounts) => {
    if (accounts.length > 0) {
        currentAccount = accounts[0];
        updateWalletButton(currentAccount);
        showConnected();
        checkMintStatus(currentAccount);
    } else {
        currentAccount = null;
        updateWalletButton(null);
    }
});
</script>
{% endblock %}
