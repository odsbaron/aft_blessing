# è‡ªåŠ¨åŒ–ç”Ÿæ—¥ç¥ç¦é‚®ä»¶ç³»ç»Ÿ
## Auto-Birthday-Wisher with NFT

> ä¸€ä¸ªè½»é‡çº§çš„è‡ªåŠ¨åŒ–ç”Ÿæ—¥ç¥ç¦ç³»ç»Ÿï¼Œæ”¯æŒå®šæ—¶æ‰«æã€é‚®ä»¶å‘é€å’Œ NFT èµ é€åŠŸèƒ½ã€‚

---

## ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [ç³»ç»Ÿæ¶æ„ä¸æŠ€æœ¯æ ˆ](#2-ç³»ç»Ÿæ¶æ„ä¸æŠ€æœ¯æ ˆ)
3. [æ•°æ®åº“è®¾è®¡](#3-æ•°æ®åº“è®¾è®¡)
4. [é¡¹ç›®ä»£ç ç»“æ„](#4-é¡¹ç›®ä»£ç ç»“æ„)
5. [æ ¸å¿ƒæ¨¡å—ä»£ç ](#5-æ ¸å¿ƒæ¨¡å—ä»£ç )
6. [NFT é¢†å–æœåŠ¡](#6-nft-é¢†å–æœåŠ¡)
7. [éƒ¨ç½²æ–¹æ¡ˆ](#7-éƒ¨ç½²æ–¹æ¡ˆ)
8. [æµ‹è¯•ä¸æ³¨æ„äº‹é¡¹](#8-æµ‹è¯•ä¸æ³¨æ„äº‹é¡¹)
9. [å¿«é€Ÿå¼€å§‹](#9-å¿«é€Ÿå¼€å§‹)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **å®šæ—¶è°ƒåº¦** | æ¯æ—¥å›ºå®šæ—¶é—´ï¼ˆå¦‚ 09:00ï¼‰è§¦å‘ä»»åŠ¡ |
| **ç²¾å‡†åŒ¹é…** | å¿½ç•¥å¹´ä»½ï¼Œä»…åŒ¹é…"æœˆ-æ—¥"ç­›é€‰å¯¿æ˜Ÿ |
| **éšæœºç¥ç¦** | ä»ç¥ç¦è¯­æ–™åº“ä¸­éšæœºæŠ½å–å†…å®¹ |
| **é˜²é‡æœºåˆ¶** | è®°å½•å‘é€å¹´ä»½ï¼Œé˜²æ­¢åŒä¸€å¤©é‡å¤å‘é€ |
| **HTML é‚®ä»¶** | æ”¯æŒç²¾ç¾çš„ HTML é‚®ä»¶æ¨¡æ¿ |
| **NFT èµ é€** | ä¸ºå¯¿æ˜Ÿç”Ÿæˆä¸“å±ç”Ÿæ—¥ NFTï¼Œæ‡’é“¸é€ æ¨¡å¼èŠ‚çœ Gas è´¹ |

### 1.2 ç³»ç»Ÿæµç¨‹

```
å®šæ—¶è§¦å‘ â†’ æ‰«æå¯¿æ˜Ÿ â†’ éšæœºç¥ç¦è¯­ â†’ ç”ŸæˆNFTé¢†å–ç  â†’ å‘é€é‚®ä»¶ â†’ ç”¨æˆ·é¢†å–NFT
```

---

## 2. ç³»ç»Ÿæ¶æ„ä¸æŠ€æœ¯æ ˆ

| åˆ†ç±» | æŠ€æœ¯é€‰å‹ |
|------|----------|
| ç¼–ç¨‹è¯­è¨€ | Python 3.9+ |
| æ•°æ®åº“ | MySQL 8.0 / SQLite / PostgreSQL |
| é‚®ä»¶åè®® | SMTP (SSL åŠ å¯†) |
| åŒºå—é“¾ | Ethereum / Polygon / Sepolia (æµ‹è¯•ç½‘) |
| æ ¸å¿ƒåº“ | pymysql, schedule, smtplib, web3.py, Flask |
| éƒ¨ç½²æ–¹æ¡ˆ | Docker + Docker Compose |

### ä¾èµ–åŒ…

```txt
pymysql==1.1.0
schedule==1.2.0
python-dotenv==1.0.0
web3==6.11.3
eth-account==0.9.0
requests==2.31.0
flask==3.0.0
```

---

## 3. æ•°æ®åº“è®¾è®¡

### 3.1 ç”¨æˆ·è¡¨ (users)

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| id | INT | ä¸»é”® | 1 |
| name | VARCHAR(50) | ç”¨æˆ·å§“å | å¼ ä¸‰ |
| email | VARCHAR(100) | æ¥æ”¶é‚®ç®±ï¼ˆå”¯ä¸€ï¼‰ | zhangsan@163.com |
| dob | DATE | å‡ºç”Ÿæ—¥æœŸ | 1995-01-17 |
| last_sent_year | INT | æœ€åå‘é€å¹´ä»½ï¼ˆé˜²é‡ï¼‰ | 2025 |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | è‡ªåŠ¨ |
| updated_at | TIMESTAMP | æ›´æ–°æ—¶é—´ | è‡ªåŠ¨ |

```sql
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    dob DATE NOT NULL,
    last_sent_year INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_birthday (MONTH(dob), DAY(dob))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 3.2 ç¥ç¦è¯­è¡¨ (wishes)

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| id | INT | ä¸»é”® |
| content | TEXT | ç¥ç¦è¯­æ­£æ–‡ |
| category | VARCHAR(20) | åˆ†ç±» (general/formal/warm/humor/poetic) |
| is_active | TINYINT(1) | æ˜¯å¦å¯ç”¨ |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ |

```sql
CREATE TABLE wishes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    content TEXT NOT NULL,
    category VARCHAR(20) DEFAULT 'general',
    is_active TINYINT(1) DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 3.3 NFT æ¨¡æ¿è¡¨ (nft_templates)

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| id | INT | ä¸»é”® |
| name | VARCHAR(100) | æ¨¡æ¿åç§° |
| image_url | VARCHAR(500) | NFT å›¾ç‰‡ URL (IPFS) |
| description | TEXT | NFT æè¿° |
| contract_address | VARCHAR(100) | NFT åˆçº¦åœ°å€ |
| is_active | TINYINT(1) | æ˜¯å¦å¯ç”¨ |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ |

```sql
CREATE TABLE nft_templates (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    image_url VARCHAR(500) NOT NULL,
    description TEXT,
    contract_address VARCHAR(100),
    is_active TINYINT(1) DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 3.4 NFT å‘é€è®°å½•è¡¨ (nft_send_logs)

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| id | INT | ä¸»é”® |
| user_id | INT | ç”¨æˆ· ID (å¤–é”®) |
| template_id | INT | æ¨¡æ¿ ID |
| token_id | VARCHAR(100) | é“¾ä¸Š Token ID |
| tx_hash | VARCHAR(100) | äº¤æ˜“å“ˆå¸Œ |
| claim_code | VARCHAR(20) | é¢†å–ç ï¼ˆå”¯ä¸€ï¼Œ6ä½ï¼‰ |
| wallet_address | VARCHAR(100) | ç”¨æˆ·é’±åŒ…åœ°å€ |
| status | VARCHAR(20) | çŠ¶æ€: minted/claimed/expired |
| minted_at | TIMESTAMP | é“¸é€ æ—¶é—´ |
| claimed_at | TIMESTAMP | é¢†å–æ—¶é—´ |
| expires_at | TIMESTAMP | è¿‡æœŸæ—¶é—´ |

```sql
CREATE TABLE nft_send_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    template_id INT NOT NULL,
    token_id VARCHAR(100),
    tx_hash VARCHAR(100),
    claim_code VARCHAR(20) NOT NULL UNIQUE,
    wallet_address VARCHAR(100),
    status VARCHAR(20) DEFAULT 'minted',
    minted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    claimed_at TIMESTAMP NULL,
    expires_at TIMESTAMP NULL,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_claim_code (claim_code),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 3.5 å‘é€æ—¥å¿—è¡¨ (send_logs)

```sql
CREATE TABLE send_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    wish_id INT,
    sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(20) DEFAULT 'success',
    error_msg TEXT,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## 4. é¡¹ç›®ä»£ç ç»“æ„

```
birthday-nft-system/
â”œâ”€â”€ .env                        # [é…ç½®] æ•æ„Ÿä¿¡æ¯ï¼ˆä¸æäº¤ï¼‰
â”œâ”€â”€ .env.example                # [é…ç½®] é…ç½®æ¨¡æ¿
â”œâ”€â”€ config.py                   # [é…ç½®] é…ç½®åŠ è½½
â”œâ”€â”€ requirements.txt            # [ä¾èµ–] Python åŒ…åˆ—è¡¨
â”œâ”€â”€ Dockerfile                  # [éƒ¨ç½²] Docker é•œåƒ
â”œâ”€â”€ docker-compose.yml          # [éƒ¨ç½²] å®¹å™¨ç¼–æ’
â”‚
â”œâ”€â”€ db_manager.py               # [æ•°æ®å±‚] æ•°æ®åº“æ“ä½œ
â”œâ”€â”€ email_service.py            # [æœåŠ¡å±‚] é‚®ä»¶å‘é€ï¼ˆHTML+NFTï¼‰
â”œâ”€â”€ nft_service.py              # [æœåŠ¡å±‚] NFT é“¸é€ ä¸é¢†å–
â”œâ”€â”€ claim_server.py             # [WebæœåŠ¡] NFT é¢†å–é¡µé¢
â”œâ”€â”€ main.py                     # [å…¥å£] å®šæ—¶ä»»åŠ¡ä¸»ç¨‹åº
â”‚
â”œâ”€â”€ init_db.py                  # [å·¥å…·] æ•°æ®åº“åˆå§‹åŒ–
â”œâ”€â”€ import_users.py             # [å·¥å…·] æ‰¹é‡å¯¼å…¥ç”¨æˆ·
â”œâ”€â”€ backup_db.py                # [å·¥å…·] æ•°æ®åº“å¤‡ä»½
â”‚
â”œâ”€â”€ static/                     # [é™æ€èµ„æº]
â”‚   â”œâ”€â”€ nft_templates/          # NFT å›¾ç‰‡æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ cake_classic.png
â”‚   â”‚   â”œâ”€â”€ balloon_modern.png
â”‚   â”‚   â””â”€â”€ star_elegant.png
â”‚   â””â”€â”€ email_template.html     # é‚®ä»¶æ¨¡æ¿
â”‚
â””â”€â”€ contracts/                  # [æ™ºèƒ½åˆçº¦]
    â”œâ”€â”€ BirthdayNFT.sol         # ERC-721 åˆçº¦
    â””â”€â”€ deploy.js               # éƒ¨ç½²è„šæœ¬
```

---

## 5. æ ¸å¿ƒæ¨¡å—ä»£ç 

### 5.1 é…ç½®æ–‡ä»¶

**`.env` æ–‡ä»¶ï¼š**

```ini
# ========== é‚®ä»¶é…ç½® ==========
MAIL_SERVER=smtp.163.com
MAIL_PORT=465
MAIL_USER=your_name@163.com
MAIL_AUTH_CODE=your_auth_code

# ========== æ•°æ®åº“é…ç½® ==========
DB_HOST=localhost
DB_USER=root
DB_PASS=your_db_password
DB_NAME=birthday_db

# ========== åŒºå—é“¾/NFT é…ç½® ==========
WEB3_NETWORK=sepolia
WEB3_RPC_URL=https://sepolia.infura.io/v3/YOUR_INFURA_KEY
WALLET_PRIVATE_KEY=your_private_key_here
NFT_CONTRACT_ADDRESS=0xYourNFTContractAddress
CLAIM_BASE_URL=https://your-domain.com/claim

# ========== IPFS é…ç½®ï¼ˆå¯é€‰ï¼‰==========
IPFS_API_URL=https://api.pinata.cloud/api/pinata
IPFS_API_KEY=your_pinata_api_key
IPFS_SECRET_KEY=your_pinata_secret
```

**`config.py`ï¼š**

```python
import os
from dotenv import load_dotenv

load_dotenv()

class Config:
    # é‚®ä»¶é…ç½®
    MAIL_SERVER = os.getenv("MAIL_SERVER")
    MAIL_PORT = int(os.getenv("MAIL_PORT", 465))
    MAIL_USER = os.getenv("MAIL_USER")
    MAIL_AUTH_CODE = os.getenv("MAIL_AUTH_CODE")

    # æ•°æ®åº“é…ç½®
    DB_HOST = os.getenv("DB_HOST")
    DB_USER = os.getenv("DB_USER")
    DB_PASS = os.getenv("DB_PASS")
    DB_NAME = os.getenv("DB_NAME")

    # NFT é…ç½®
    WEB3_NETWORK = os.getenv("WEB3_NETWORK", "sepolia")
    WEB3_RPC_URL = os.getenv("WEB3_RPC_URL")
    WALLET_PRIVATE_KEY = os.getenv("WALLET_PRIVATE_KEY")
    NFT_CONTRACT_ADDRESS = os.getenv("NFT_CONTRACT_ADDRESS")
    CLAIM_BASE_URL = os.getenv("CLAIM_BASE_URL", "http://localhost:8000/claim")

    # å¸¸é‡
    CLAIM_CODE_LENGTH = 6
    CLAIM_EXPIRE_DAYS = 30
```

### 5.2 æ•°æ®å±‚ (db_manager.py)

```python
import pymysql
from config import Config
from datetime import datetime

class DBManager:
    def __init__(self):
        self.conn = pymysql.connect(
            host=Config.DB_HOST,
            user=Config.DB_USER,
            password=Config.DB_PASS,
            database=Config.DB_NAME,
            cursorclass=pymysql.cursors.DictCursor
        )

    # ========== ç”Ÿæ—¥ç›¸å…³ ==========
    def get_todays_birthdays(self):
        """è·å–ä»Šå¤©è¿‡ç”Ÿæ—¥ä¸”ä»Šå¹´æœªå‘é€çš„ç”¨æˆ·"""
        today = datetime.now()
        sql = """
            SELECT id, name, email, dob
            FROM users
            WHERE MONTH(dob) = %s AND DAY(dob) = %s
              AND (last_sent_year IS NULL OR last_sent_year < %s)
        """
        with self.conn.cursor() as cursor:
            cursor.execute(sql, (today.month, today.day, today.year))
            return cursor.fetchall()

    def update_send_status(self, user_id):
        """æ›´æ–°å‘é€çŠ¶æ€"""
        sql = "UPDATE users SET last_sent_year = %s WHERE id = %s"
        with self.conn.cursor() as cursor:
            cursor.execute(sql, (datetime.now().year, user_id))
        self.conn.commit()

    # ========== ç¥ç¦è¯­ç›¸å…³ ==========
    def get_random_wish(self):
        """éšæœºè·å–ä¸€æ¡ç¥ç¦è¯­"""
        sql = "SELECT content FROM wishes WHERE is_active = 1 ORDER BY RAND() LIMIT 1"
        with self.conn.cursor() as cursor:
            cursor.execute(sql)
            result = cursor.fetchone()
            return result['content'] if result else "ç”Ÿæ—¥å¿«ä¹ï¼"

    # ========== NFT ç›¸å…³ ==========
    def get_random_nft_template(self):
        """éšæœºè·å–å¯ç”¨çš„ NFT æ¨¡æ¿"""
        sql = """
            SELECT id, name, image_url, description
            FROM nft_templates
            WHERE is_active = 1
            ORDER BY RAND()
            LIMIT 1
        """
        with self.conn.cursor() as cursor:
            cursor.execute(sql)
            return cursor.fetchone()

    def get_nft_by_claim_code(self, claim_code):
        """æ ¹æ®é¢†å–ç æŸ¥è¯¢ NFT"""
        sql = """
            SELECT n.*, u.name as user_name
            FROM nft_send_logs n
            JOIN users u ON n.user_id = u.id
            WHERE n.claim_code = %s
        """
        with self.conn.cursor() as cursor:
            cursor.execute(sql, (claim_code,))
            return cursor.fetchone()

    # ========== ç”¨æˆ·ç®¡ç† ==========
    def add_user(self, name, email, dob):
        """æ·»åŠ å•ä¸ªç”¨æˆ·"""
        sql = "INSERT IGNORE INTO users (name, email, dob) VALUES (%s, %s, %s)"
        with self.conn.cursor() as cursor:
            cursor.execute(sql, (name, email, dob))
        self.conn.commit()
        return cursor.rowcount > 0

    def get_user_stats(self):
        """è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯"""
        sql = """
            SELECT
                COUNT(*) as total_users,
                SUM(CASE WHEN MONTH(dob) = MONTH(CURDATE()) AND DAY(dob) = DAY(CURDATE()) THEN 1 ELSE 0 END) as today_birthdays,
                SUM(CASE WHEN MONTH(dob) = MONTH(CURDATE()) THEN 1 ELSE 0 END) as this_month_birthdays
            FROM users
        """
        with self.conn.cursor() as cursor:
            cursor.execute(sql)
            return cursor.fetchone()

    def close(self):
        self.conn.close()
```

### 5.3 é‚®ä»¶æœåŠ¡å±‚ (email_service.py)

```python
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.header import Header
from email.utils import formataddr
from config import Config

def build_html_email(user_name, wish_content, nft_info=None):
    """æ„å»º HTML é‚®ä»¶å†…å®¹"""
    nft_section = ""
    if nft_info:
        nft_section = f"""
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 30px; margin-top: 30px; text-align: center;">
            <h2 style="color: white; margin: 0 0 15px 0;">ğŸ ä¸“å±ç”Ÿæ—¥ NFT</h2>
            <p style="color: rgba(255,255,255,0.9);">æˆ‘ä»¬ä¸ºæ‚¨é“¸é€ äº†ä¸€æšç‹¬ä¸€æ— äºŒçš„ç”Ÿæ—¥çºªå¿µ NFTï¼</p>

            <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 20px; margin: 20px auto; max-width: 300px;">
                <img src="{nft_info.get('image_url', 'https://via.placeholder.com/200')}"
                     alt="Birthday NFT" style="width: 100%; border-radius: 8px;">
            </div>

            <p style="color: white; margin: 15px 0;">
                <strong>é¢†å–ç ï¼š</strong>
                <span style="background: white; color: #667eea; padding: 8px 16px; border-radius: 6px; font-family: monospace; font-size: 18px;">
                    {nft_info['claim_code']}
                </span>
            </p>

            <a href="{nft_info['claim_url']}" style="display: inline-block; background: white; color: #667eea; padding: 12px 30px; border-radius: 25px; text-decoration: none; font-weight: bold; margin-top: 10px;">
                ç«‹å³é¢†å– NFT â†’
            </a>

            <p style="color: rgba(255,255,255,0.8); font-size: 12px; margin: 15px 0 0 0;">
                æœ‰æ•ˆæœŸè‡³ï¼š{nft_info['expires_at']}
            </p>
        </div>
        """

    return f"""
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8">
        <style>
            body {{ font-family: 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; }}
            .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}
            .header {{ text-align: center; padding: 30px 0; }}
            .header h1 {{ color: #667eea; margin: 0; }}
            .content {{ background: #f8f9fa; border-radius: 12px; padding: 30px; }}
            .cake {{ font-size: 60px; text-align: center; margin: 20px 0; }}
            .footer {{ text-align: center; padding: 20px; color: #888; font-size: 12px; }}
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>ğŸ‚ ç”Ÿæ—¥å¿«ä¹ï¼</h1>
            </div>
            <div class="content">
                <div class="cake">ğŸ‚</div>
                <h2 style="text-align: center; color: #333;">äº²çˆ±çš„ {user_name}</h2>
                <p style="font-size: 16px; line-height: 1.8;">{wish_content}</p>
                {nft_section}
            </div>
            <div class="footer">
                <p>â€”â€” æ‚¨çš„è‡ªåŠ¨åŒ–ç”Ÿæ—¥ç¥ç¦åŠ©æ‰‹</p>
                <p>è¿™æ˜¯ä¸€å°è‡ªåŠ¨å‘é€çš„é‚®ä»¶ï¼Œè¯·å‹¿ç›´æ¥å›å¤</p>
            </div>
        </div>
    </body>
    </html>
    """

def send_birthday_email(to_email, user_name, wish_content, nft_info=None):
    """å‘é€ç”Ÿæ—¥é‚®ä»¶"""
    try:
        msg = MIMEMultipart('alternative')
        msg['From'] = formataddr((Header("ç”Ÿæ—¥ç¥ç¦åŠ©æ‰‹", 'utf-8').encode(), Config.MAIL_USER))
        msg['To'] = formataddr((Header(user_name, 'utf-8').encode(), to_email))
        msg['Subject'] = Header(f"ğŸ‚ {user_name}ï¼Œç”Ÿæ—¥å¿«ä¹ï¼", 'utf-8')

        # HTML å†…å®¹
        html_content = build_html_email(user_name, wish_content, nft_info)
        msg.attach(MIMEText(html_content, 'html', 'utf-8'))

        # å‘é€
        server = smtplib.SMTP_SSL(Config.MAIL_SERVER, Config.MAIL_PORT)
        server.login(Config.MAIL_USER, Config.MAIL_AUTH_CODE)
        server.sendmail(Config.MAIL_USER, [to_email], msg.as_string())
        server.quit()

        print(f"âœ… [å‘é€æˆåŠŸ] -> {to_email}")
        return True

    except Exception as e:
        print(f"âŒ [å‘é€å¤±è´¥] -> {to_email}, é”™è¯¯: {e}")
        return False
```

### 5.4 NFT æœåŠ¡å±‚ (nft_service.py)

```python
import secrets
import string
from web3 import Web3
from eth_account import Account
from config import Config
from datetime import datetime, timedelta

class NFTService:
    def __init__(self):
        self.w3 = Web3(Web3.HTTPProvider(Config.WEB3_RPC_URL))
        self.account = Account.from_key(Config.WALLET_PRIVATE_KEY)

    def generate_claim_code(self):
        """ç”Ÿæˆ 6 ä½éšæœºé¢†å–ç """
        chars = string.ascii_uppercase + string.digits
        return ''.join(secrets.choice(chars) for _ in range(Config.CLAIM_CODE_LENGTH))

    def lazy_mint_nft(self, user_id, template_id, db_manager):
        """æ‡’é“¸é€ ï¼šç”Ÿæˆé¢†å–ç ï¼Œç”¨æˆ·é¢†å–æ—¶æ‰çœŸæ­£é“¸é€ """
        claim_code = self.generate_claim_code()
        expires_at = datetime.now() + timedelta(days=Config.CLAIM_EXPIRE_DAYS)
        token_id = f"{datetime.now().timestamp()}_{user_id}"

        sql = """
            INSERT INTO nft_send_logs (user_id, template_id, token_id, claim_code, expires_at)
            VALUES (%s, %s, %s, %s, %s)
        """
        with db_manager.conn.cursor() as cursor:
            cursor.execute(sql, (user_id, template_id, token_id, claim_code, expires_at))
        db_manager.conn.commit()

        return {
            'claim_code': claim_code,
            'token_id': token_id,
            'claim_url': f"{Config.CLAIM_BASE_URL}/{claim_code}",
            'expires_at': expires_at.strftime('%Y-%m-%d %H:%M:%S')
        }

    def claim_nft(self, claim_code, wallet_address, db_manager):
        """ç”¨æˆ·é¢†å– NFT"""
        # æŸ¥è¯¢è®°å½•
        sql = "SELECT * FROM nft_send_logs WHERE claim_code = %s AND status = 'minted'"
        with db_manager.conn.cursor() as cursor:
            cursor.execute(sql, (claim_code,))
            record = cursor.fetchone()

        if not record:
            return {'success': False, 'message': 'æ— æ•ˆçš„é¢†å–ç '}

        if record['expires_at'] and record['expires_at'] < datetime.now():
            return {'success': False, 'message': 'é¢†å–ç å·²è¿‡æœŸ'}

        # TODO: å®é™…é“¸é€ åˆ°é“¾ä¸Š
        # tx_hash = self.mint_to_blockchain(wallet_address, ...)

        # æ›´æ–°çŠ¶æ€
        update_sql = """
            UPDATE nft_send_logs
            SET wallet_address = %s, status = 'claimed', claimed_at = NOW()
            WHERE id = %s
        """
        with db_manager.conn.cursor() as cursor:
            cursor.execute(update_sql, (wallet_address, record['id']))
        db_manager.conn.commit()

        return {'success': True, 'message': 'NFT é¢†å–æˆåŠŸï¼'}

    def _get_erc721_abi(self):
        """ERC-721 ABIï¼ˆç®€åŒ–ç‰ˆï¼‰"""
        return [{
            "inputs": [
                {"internalType": "address", "name": "to", "type": "address"},
                {"internalType": "string", "name": "uri", "type": "string"}
            ],
            "name": "mint",
            "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
            "stateMutability": "nonpayable",
            "type": "function"
        }]
```

### 5.5 ä¸»ç¨‹åºå…¥å£ (main.py)

```python
import schedule
import time
from db_manager import DBManager
from email_service import send_birthday_email
from nft_service import NFTService

def job_scan_and_send():
    print("ğŸ”„ å¼€å§‹æ‰§è¡Œæ¯æ—¥æ‰«æä»»åŠ¡...")
    db = DBManager()
    nft_service = NFTService()

    try:
        users = db.get_todays_birthdays()

        if not users:
            print("ğŸ“­ ä»Šå¤©æš‚æ—¶æ²¡æœ‰äººè¿‡ç”Ÿæ—¥ã€‚")
            return

        print(f"ğŸ‰ å‘ç° {len(users)} ä½å¯¿æ˜Ÿï¼Œå‡†å¤‡å‘é€...")

        for user in users:
            wish = db.get_random_wish()

            # ç”Ÿæˆ NFT
            nft_info = None
            try:
                template = db.get_random_nft_template()
                if template:
                    nft_result = nft_service.lazy_mint_nft(user['id'], template['id'], db)
                    nft_info = {
                        'claim_code': nft_result['claim_code'],
                        'claim_url': nft_result['claim_url'],
                        'expires_at': nft_result['expires_at'],
                        'image_url': template['image_url']
                    }
                    print(f"ğŸ NFT å·²å‡†å¤‡ï¼Œé¢†å–ç : {nft_info['claim_code']}")
            except Exception as e:
                print(f"âš ï¸ NFT ç”Ÿæˆå¤±è´¥: {e}")

            # å‘é€é‚®ä»¶
            is_sent = send_birthday_email(user['email'], user['name'], wish, nft_info)

            if is_sent:
                db.update_send_status(user['id'])

    except Exception as e:
        print(f"âš ï¸ ä»»åŠ¡æ‰§è¡Œå‡ºé”™: {e}")
    finally:
        db.close()
        print("ğŸ æœ¬æ¬¡ä»»åŠ¡ç»“æŸã€‚\n")

def run():
    schedule.every().day.at("09:00").do(job_scan_and_send)
    print("ğŸš€ ç³»ç»Ÿå·²å¯åŠ¨ï¼Œç­‰å¾…å®šæ—¶ä»»åŠ¡è§¦å‘...")

    while True:
        schedule.run_pending()
        time.sleep(1)

if __name__ == "__main__":
    run()
```

---

## 6. NFT é¢†å–æœåŠ¡

### 6.1 Flask é¢†å–æœåŠ¡å™¨ (claim_server.py)

```python
from flask import Flask, request, jsonify, render_template_string
from nft_service import NFTService
from db_manager import DBManager

app = Flask(__name__)
nft_service = NFTService()

CLAIM_HTML = """
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>é¢†å–ç”Ÿæ—¥ NFT</title>
    <style>
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .container { background: white; border-radius: 20px; padding: 40px; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        h1 { color: #667eea; text-align: center; }
        input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; box-sizing: border-box; margin: 10px 0; }
        button { width: 100%; background: #667eea; color: white; padding: 15px; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; margin-top: 20px; }
        button:hover { background: #5568d3; }
        .error { color: #e74c3c; text-align: center; margin-top: 15px; }
        .success { color: #27ae60; text-align: center; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ é¢†å–ç”Ÿæ—¥ NFT</h1>
        <p style="text-align: center; color: #888;">è¯·è¾“å…¥æ‚¨çš„é’±åŒ…åœ°å€</p>
        <input type="text" id="wallet" placeholder="0x..." />
        <button onclick="claim()">ç«‹å³é¢†å–</button>
        <div id="message"></div>
    </div>
    <script>
        const claimCode = '{{ claim_code }}';
        async function claim() {
            const wallet = document.getElementById('wallet').value;
            const msgDiv = document.getElementById('message');
            if (!wallet.startsWith('0x') || wallet.length !== 42) {
                msgDiv.innerHTML = '<p class="error">è¯·è¾“å…¥æœ‰æ•ˆçš„ä»¥å¤ªåŠåœ°å€</p>';
                return;
            }
            const res = await fetch('/api/claim', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({claim_code: claimCode, wallet_address: wallet})
            });
            const data = await res.json();
            if (data.success) {
                msgDiv.innerHTML = '<p class="success">âœ… ' + data.message + '</p>';
            } else {
                msgDiv.innerHTML = '<p class="error">âŒ ' + data.message + '</p>';
            }
        }
    </script>
</body>
</html>
"""

@app.route('/claim/<claim_code>')
def claim_page(claim_code):
    return render_template_string(CLAIM_HTML, claim_code=claim_code)

@app.route('/api/claim', methods=['POST'])
def claim_api():
    data = request.json
    db = DBManager()
    try:
        result = nft_service.claim_nft(data['claim_code'], data['wallet_address'], db)
        return jsonify(result)
    finally:
        db.close()

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8000)
```

---

## 7. éƒ¨ç½²æ–¹æ¡ˆ

### 7.1 Dockerfile

```dockerfile
FROM python:3.9-slim

WORKDIR /app

RUN apt-get update && apt-get install -y gcc && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

ENV TZ=Asia/Shanghai
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

CMD ["sh", "-c", "python claim_server.py & python main.py"]
```

### 7.2 Docker Compose

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: your_password
      MYSQL_DATABASE: birthday_db
    volumes:
      - mysql_data:/var/lib/mysql
    restart: always

  bot:
    build: .
    depends_on:
      - mysql
    environment:
      DB_HOST: mysql
      DB_USER: root
      DB_PASS: your_password
      DB_NAME: birthday_db
    ports:
      - "8000:8000"
    restart: always

volumes:
  mysql_data:
```

### 7.3 éƒ¨ç½²å‘½ä»¤

```bash
# æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f bot
```

---

## 8. æµ‹è¯•ä¸æ³¨æ„äº‹é¡¹

| æ³¨æ„äº‹é¡¹ | è¯´æ˜ |
|----------|------|
| æ—¶é—´ä¸€è‡´æ€§ | ç¡®ä¿æœåŠ¡å™¨æ—¶é—´å‡†ç¡®ï¼Œå¦åˆ™æ—¥æœŸåˆ¤æ–­å¯èƒ½å‡ºé”™ |
| åƒåœ¾é‚®ä»¶é£æ§ | æµ‹è¯•æ—¶é¿å…çŸ­æ—¶é—´å†…å‘åŒä¸€é‚®ç®±å‘é€å¤§é‡é‚®ä»¶ |
| SQL å…¼å®¹æ€§ | MySQL ä½¿ç”¨ `MONTH()/DAY()`ï¼ŒSQLite éœ€æ”¹ä¸º `strftime()` |
| NFT æµ‹è¯•ç½‘ | å¼€å‘æ—¶ä½¿ç”¨ Sepolia æµ‹è¯•ç½‘ï¼Œé¿å…æ¶ˆè€—çœŸå® ETH |
| ç§é’¥å®‰å…¨ | `WALLET_PRIVATE_KEY` ç»å¯¹ä¸è¦æäº¤åˆ° Git |
| Gas è´¹ç”¨ | æ‡’é“¸é€ æ¨¡å¼å¯èŠ‚çœ Gas è´¹ï¼Œç”¨æˆ·é¢†å–æ—¶æ‰ä¸Šé“¾ |
| IPFS å­˜å‚¨ | NFT å›¾ç‰‡å»ºè®®å­˜å‚¨åœ¨ IPFS ä¸Š |

---

## 9. å¿«é€Ÿå¼€å§‹

### 9.1 ç¯å¢ƒå‡†å¤‡

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env å¡«å…¥çœŸå®é…ç½®

# åˆå§‹åŒ–æ•°æ®åº“
python init_db.py

# å¯¼å…¥ç”¨æˆ·ï¼ˆå¯é€‰ï¼‰
python import_users.py users.csv
```

### 9.2 å¯åŠ¨æœåŠ¡

```bash
# æ–¹å¼ä¸€ï¼šç›´æ¥å¯åŠ¨
sh -c "python claim_server.py & python main.py"

# æ–¹å¼äºŒï¼šDocker
docker-compose up -d
```

### 9.3 CSV å¯¼å…¥æ ¼å¼

```csv
name,email,dob
å¼ ä¸‰,zhangsan@example.com,1995-01-17
æå››,lisi@example.com,1998-06-23
ç‹äº”,wangwu@example.com,1992-12-08
```

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼šv2.1** | **æ›´æ–°æ—¥æœŸï¼š2025-01-16**
